<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>GSA Per Diem Lookup</title>
  
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  
  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <style>
    body {
      margin: 20px;
    }
    #map {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #data-container {
      height: 500px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      background: #f8f9fa;
    }
    .month-section {
      padding: 5px;
      margin-bottom: 5px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1 class="mb-4 text-center">GSA Per Diem Lookup</h1>

  <div class="container">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="city" class="form-label">City:</label>
        <input type="text" id="city" class="form-control" placeholder="e.g. Boston">
      </div>
      <div class="col-md-2">
        <label for="state" class="form-label">State (2-letter):</label>
        <input type="text" id="state" class="form-control" placeholder="e.g. MA">
      </div>
      <div class="col-md-2">
        <label for="zip" class="form-label">Zip:</label>
        <input type="text" id="zip" class="form-control" placeholder="e.g. 02108">
      </div>
      <div class="col-md-2">
        <label for="year" class="form-label">Year:</label>
        <input type="number" id="year" class="form-control" value="2025">
      </div>
      <div class="col-md-2">
        <button id="lookupBtn" class="btn btn-primary w-100">Lookup</button>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-8">
        <div id="map"></div>
      </div>
      <div class="col-md-4">
        <div id="data-container">
          <h4>Per Diem Rates</h4>
          <div id="results"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ============================
// Cloudflare Worker API Setup
// ============================
const workerURL = "https://bushes.dassey.workers.dev/"; 

// ============================
// Map Initialization
// ============================
const map = L.map("map").setView([39.8283, -98.5795], 4);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

let geoJsonLayer = null;

// ============================
// UI Elements and Event Listeners
// ============================
const lookupBtn = document.getElementById("lookupBtn");
const cityInput = document.getElementById("city");
const stateInput = document.getElementById("state");
const zipInput = document.getElementById("zip");
const yearInput = document.getElementById("year");
const resultsDiv = document.getElementById("results");

lookupBtn.addEventListener("click", async () => {
    let city = cityInput.value.trim();
    let state = stateInput.value.trim().toUpperCase();
    let zip = zipInput.value.trim();
    let year = yearInput.value.trim() || new Date().getFullYear();

    resultsDiv.innerHTML = "";
    clearMapLayers();

    let queryParams = new URLSearchParams({ city, state, zip, year }).toString();
    let endpoint = `${workerURL}?${queryParams}`;

    try {
        const response = await fetch(endpoint);
        const gsaData = await response.json();

        if (!gsaData || !gsaData.rates || !gsaData.rates.length) {
            resultsDiv.innerHTML = "<p class='text-warning'>No per diem data found.</p>";
            return;
        }

        displayPerDiemData(gsaData.rates[0]);

        if (zip) {
            await loadZipPolygon(zip);
        } else if (city && state) {
            await loadCityPolygon(city, state);
        }
    } catch (err) {
        resultsDiv.innerHTML = "<p class='text-danger'>API request failed.</p>";
    }
});

// ============================
// Fetch City Polygon Data
// ============================
async function getCityPolygon(city, state) {
    const nominatimUrl = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}&format=json&polygon_geojson=1`;

    try {
        const response = await fetch(nominatimUrl);
        const data = await response.json();
        
        if (data.length > 0 && data[0].geojson) {
            return { geojson: data[0].geojson, lat: data[0].lat, lon: data[0].lon };
        }
    } catch (err) {
        console.error("Error fetching city polygon:", err);
    }
    return null;
}

// ============================
// Load City Polygon Onto Map
// ============================
async function loadCityPolygon(city, state) {
    const cityData = await getCityPolygon(city, state);
    
    if (cityData) {
        if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
        }

        geoJsonLayer = L.geoJSON(cityData.geojson, {
            style: { color: "blue", weight: 2, opacity: 0.6, fillOpacity: 0.2 }
        }).addTo(map);

        map.fitBounds(geoJsonLayer.getBounds());
    } else {
        console.warn("No polygon found for", city, state);
    }
}

// ============================
// Display Per Diem Data in UI
// ============================
function displayPerDiemData(rateData) {
    const rateInfo = rateData.rate[0];
    const meals = rateInfo.meals || "N/A";
    const lodgingData = rateInfo.months ? rateInfo.months.month : [];

    resultsDiv.innerHTML = `
      <p><strong>City:</strong> ${rateInfo.city || "Standard Rate"}</p>
      <p><strong>State:</strong> ${rateData.state}</p>
      <p><strong>County:</strong> ${rateInfo.county || "N/A"}</p>
      <p><strong>Meals (M&IE):</strong> $${meals}</p>
      <h5>Monthly Lodging Rates:</h5>
    `;

    if (lodgingData.length > 0) {
        lodgingData.forEach(monthData => {
            resultsDiv.innerHTML += `
              <div class="month-section">
                <h6>${monthData.long}</h6>
                <p><strong>Lodging:</strong> $${monthData.value}</p>
              </div>
            `;
        });
    } else {
        resultsDiv.innerHTML += `<p class="text-muted">No monthly lodging data available.</p>`;
    }
}

// ============================
// Clear Map Layers
// ============================
function clearMapLayers() {
    if (geoJsonLayer) {
        map.removeLayer(geoJsonLayer);
        geoJsonLayer = null;
    }
}

// ============================
// Load ZIP Polygon Onto Map
// ============================
async function loadZipPolygon(zip) {
    try {
        const response = await fetch(`output_polygons/${zip}.geojson`);
        if (!response.ok) throw new Error("GeoJSON not found");
        const geoJsonData = await response.json();
        geoJsonLayer = L.geoJSON(geoJsonData, { color: "green" }).addTo(map);
        map.fitBounds(geoJsonLayer.getBounds());
    } catch (err) {
        console.warn(`No polygon found for ZIP ${zip}.`);
    }
}

// ============================
// Fetch Connected Areas
// ============================
async function getConnectedAreas(city, state) {
    const nominatimUrl = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}&format=json&polygon_geojson=1&extratags=1`;

    try {
        const response = await fetch(nominatimUrl);
        const data = await response.json();

        if (data.length === 0 || !data[0].geojson) return null;
        return await getAdjacentBoundaries(data[0].osm_id, data[0].geojson);
    } catch (err) {
        console.error("Error fetching city polygon:", err);
        return null;
    }
}

// ============================
// Fetch Adjacent Boundaries
// ============================
async function getAdjacentBoundaries(osmID, mainPolygon) {
    const overpassQuery = `
        [out:json];
        relation(${osmID});
        map_to_area;
        (
            way(area)[boundary=administrative];
            relation(area)[boundary=administrative];
        );
        out geom;
    `;

    const overpassURL = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`;

    try {
        const response = await fetch(overpassURL);
        const data = await response.json();

        if (!data.elements) return [];

        let connectedAreas = [];
        for (const element of data.elements) {
            if (element.type === "relation" && element.tags.name) {
                connectedAreas.push({
                    name: element.tags.name,
                    geojson: element.members.filter(m => m.type === "way").map(m => m.geometry),
                });
            }
        }
        return connectedAreas;
    } catch (err) {
        console.error("Error fetching adjacent areas:", err);
        return [];
    }
}

// ============================
// Load Connected Areas on Map
// ============================
async function loadConnectedAreas(city, state) {
    const connectedAreas = await getConnectedAreas(city, state);

    if (!connectedAreas || connectedAreas.length === 0) {
        console.warn("No connected areas found.");
        return;
    }

    for (const area of connectedAreas) {
        if (area.geojson.length === 0) continue;

        let areaPolygon = {
            type: "Feature",
            geometry: {
                type: "MultiPolygon",
                coordinates: [area.geojson.map(p => p.map(coord => [coord.lon, coord.lat]))]
            },
            properties: { name: area.name }
        };

        const perDiemRate = await getPerDiemForArea(area.name, state);
        const labelText = `${area.name}\nM&IE: $${perDiemRate.meals || "N/A"}\nLodging: $${perDiemRate.lodging || "N/A"}`;

        L.geoJSON(areaPolygon, {
            style: { color: "green", weight: 2, opacity: 0.6, fillOpacity: 0.2 }
        }).addTo(map).bindTooltip(labelText, { permanent: true, direction: "center", className: "perdiem-label" });
    }
}

</script>
</body>
</html>

